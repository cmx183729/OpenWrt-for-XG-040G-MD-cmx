name: Build_XG_040G_MD-immortalwrt

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      log_switch:
        description: "å¼€å¯è¯¦ç»†æ—¥å¿—"
        required: false
        default: false
        type: boolean

env:
  CONFIG_FILE: "config/xg-040g-md.config"
  REPO_URL: https://github.com/immortalwrt/immortalwrt.git
  # ä¿®æ­£ï¼šå®˜æ–¹æ—  25.12 åˆ†æ”¯ï¼Œæ”¹ç”¨ master
  REPO_BRANCH: openwrt-25.12
  FEEDS_CONF: feeds.conf.default
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        # ä¿®æ­£ï¼šå®˜æ–¹æœ€æ–°ä¸º v4ï¼Œv6 æ˜¯ç¬”è¯¯
        uses: actions/checkout@v6

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Setup environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-setuptools python3-pyelftools rsync swig unzip zlib1g-dev file wget \
            squashfs-tools mkbootimg device-tree-compiler
          sudo timedatectl set-timezone "$TZ"

      - name: Clone Source Code
        run: |
          git clone --depth 1 --branch "$REPO_BRANCH" "$REPO_URL" openwrt

      - name: Apply Custom Patches (ä¿®å¤è¡¥ä¸åŠ è½½é€»è¾‘)
        run: |
          # 1. åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p openwrt/target/linux/airoha/an7581/base-files/etc/board.d/
          mkdir -p openwrt/target/linux/airoha/image/
          mkdir -p openwrt/target/linux/airoha/dts/
          mkdir -p openwrt/package/kernel/linux/modules/
          mkdir -p openwrt/files/etc/uci-defaults/
          # [æ–°å¢ž] åˆ›å»ºå†…æ ¸è¡¥ä¸ç›®å½•
          mkdir -p openwrt/target/linux/airoha/patches-6.12/

          # 2. å¤åˆ¶åŸºç¡€æ–‡ä»¶ (å…¼å®¹ä¸¤ç§æ–‡ä»¶å)
          if [ -f patch/02_network ]; then cp -f patch/02_network openwrt/target/linux/airoha/an7581/base-files/etc/board.d/02_network; fi
          if [ -f patch/02_network.txt ]; then cp -f patch/02_network.txt openwrt/target/linux/airoha/an7581/base-files/etc/board.d/02_network; fi
          
          [ -f patch/an7581.mk ] && cp -f patch/an7581.mk openwrt/target/linux/airoha/image/an7581.mk
          [ -f patch/an7581-bell_xg-040g-md.dts ] && cp -f patch/an7581-bell_xg-040g-md.dts openwrt/target/linux/airoha/dts/an7581-bell_xg-040g-md.dts
          [ -f patch/target.mk ] && cp -f patch/target.mk openwrt/target/linux/airoha/an7581/target.mk
          [ -f patch/config-6.12 ] && cp -f patch/config-6.12 openwrt/target/linux/airoha/an7581/config-6.12
          [ -f patch/netdevices.mk ] && cp -f patch/netdevices.mk openwrt/package/kernel/linux/modules/netdevices.mk

          # 3. [æ–°å¢ž] è‡ªåŠ¨åº”ç”¨ä½œè€…çš„æ–°å†…æ ¸è¡¥ä¸ (342-mtd... ç­‰)
          if ls patch/*.patch 1> /dev/null 2>&1; then
            cp -f patch/*.patch openwrt/target/linux/airoha/patches-6.12/
            echo "âœ… Kernel patches applied."
          else
            echo "âš ï¸ No patch files found."
          fi

          # 4. å¤åˆ¶å¼€æœºä¼˜åŒ–è„šæœ¬
          if [ -f patch/99-init-settings ]; then
            cp -f patch/99-init-settings openwrt/files/etc/uci-defaults/99-init-settings
            chmod +x openwrt/files/etc/uci-defaults/99-init-settings
          fi

      - name: Update & Install feeds
        working-directory: ./openwrt
        run: |
          if [ -f ../$FEEDS_CONF ]; then
            cp -f ../$FEEDS_CONF ./feeds.conf.default
          fi
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # å®‰è£…ä½ éœ€è¦çš„æ’ä»¶
          ./scripts/feeds install luci luci-base luci-app-passwall luci-app-lucky luci-app-rtp2httpd luci-app-turboacc luci-app-nlbwmon luci-app-arpbind luci-app-eqos || true

      - name: Copy configuration and defconfig
        run: |
          [ -f "${CONFIG_FILE}" ] && cp -fv "${CONFIG_FILE}" openwrt/.config
          cd openwrt
          make defconfig
          [ -f .config ] && cp .config defconfig-final.config

      - name: Upload build config files
        uses: actions/upload-artifact@v6
        with:
          name: build-config
          path: |
            openwrt/defconfig-final.config
            openwrt/feeds.conf.default

      - name: Download packages
        working-directory: ./openwrt
        run: |
          make download -j8
          find dl -size -1024c -delete

      - name: Compile Firmware
        id: compile
        run: |
          cd openwrt
          echo "Starting Compile..."
          if [[ "${{ inputs.log_switch }}" == "true" ]]; then
            make -j1 V=s
          else
            make -j$(nproc) || make -j1 V=s
          fi
          
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Prepare firmware artifacts
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true'
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v6
        if: env.UPLOAD_FIRMWARE == 'true'
        with:
          name: ImmortalWrt_firmware${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}/*

      - name: Generate release tag
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          cat <<EOF > release.txt
          ðŸš€ ImmortalWrt firmware for XG-040G-MD
          ----------------------
          æž„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M")
          EOF

      - name: Publish GitHub Release
        uses: ncipollo/release-action@v1
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          tag: ${{ steps.tag.outputs.release_tag }}
          bodyFile: release.txt
          artifacts: ${{ env.FIRMWARE }}/*
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
